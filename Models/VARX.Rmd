---
title: "VARX Model on endogenous and exogenous"
output: html_notebook
---
```{r}
library(tscount)
library(urca)
```

```{r}
#Load dataset
full_df <- read.csv("/home/angps/Documents/Thesis/Data/full_df_with_exo.csv")
df_atleast_50cts <- read.csv("/home/angps/Documents/Thesis/Data/df_>=50_with_exo.csv")
```

```{r}
#RMSE function definition
RMSE = function(act, pred){
  sqrt(mean((act - pred)^2))
}

#Split into training and test set
#train <- df_atleast_50cts[,1:162]
#test <- df_atleast_50cts[,163:204]
#train <- df_atleast_50cts[c(1:47, 50:55),1:162]
#test <- df_atleast_50cts[c(1:47, 50:55),163:204]
train <- df_atleast_50cts[c(1:47, 50:55),]

```


```{r}
df_t <- t(df_atleast_50cts)
colnames(df_t) = c(1:55)
stationary_test = ca.jo(df_t, type="eigen", K=2, ecdet="none", spec="longrun")
summary(stationary_test)
```

```{r}
###WITH EXOGENOUS VARIABLES###
library(BigVAR)
Y = data.matrix(t(train))
VARX = list()
VARX$k = 42  #endogenous
VARX$s = 1
model = constructModel(as.matrix(Y), p = 2, struct="EFX", MN = F, gran = c(25,10), VARX = VARX, T1 = 81, T2 = 162)
var_model <- cv.BigVAR(model)
```
```{r}
var_model
```

```{r}
plot(as.vector(var_model@resids), main="Residuals plot of VARX model", 
  xlab="Index", ylab="Residuals")
dev.copy(jpeg,filename="/home/angps/Documents/Thesis/Report/Images/VARX_resids.jpg");
dev.off ();
hist(var_model@resids)
```

```{r}
plot(as.vector(var_model@fitted),as.vector(var_model@resids), main="Plot of residuals against fitted values", 
  xlab="Fitted Values", ylab="Residuals")
dev.copy(jpeg,filename="/home/angps/Documents/Thesis/Report/Images/VARX_resids_vs_values.jpg");
dev.off ();
```

```{r}
acf(as.vector(var_model@resids), main="ACF plots of residuals")
dev.copy(jpeg,filename="/home/angps/Documents/Thesis/Report/Images/VARX_acf.jpg");
dev.off ();
```

```{r}
plot(var_model, main = "Penalty Grid Position (VARX Model)")
dev.copy(jpeg,filename="/home/angps/Documents/Thesis/Report/Images/VARX_pengrid.jpg");
dev.off();
```

```{r}
SparsityPlot.BigVAR.results(var_model)
dev.copy(jpeg,filename="/home/angps/Documents/Thesis/Report/Images/VARX_sparsity.jpg");
dev.off();
```

```{r}
for (obs in c(6,12,18)) {
  for (m in c(6, 12, 18, 24)) {
      errors <- c()
      for (i in c(1:dim(train)[1])) {
          fit <- suppressWarnings(tsglm(as.numeric(train[i,]), model = list(past_obs = c(1:obs), past_mean = m)))
          pred <- predict(fit, n.ahead=42)
          rmse <- RMSE(as.numeric(test[i,]),pred$pred)
          errors <- c(errors,rmse)
      }
      print(paste0("Max Past ObsL ", obs ," Past Mean: ", m, " RMSE: ", mean(errors)))
  }
}

```







```{r}
#library(vars)
#model <- VARselect(t(train[1:32,]))
#model$selection
#model <- VAR(t(train[1:32,]), p = 5, season = NULL, 
#    exog = NULL)
#summary(model)
```
```{r}
#train_full <- t(full_df)[1:162,]
#test_full <- t(full_df)[163:204,]
#On full dataset
#model <- VARselect(train_full)
#model$selection
#model <- VAR(t(train_full), p = 1, season = NULL, exog = NULL)
#summary(model)

#Residual test
#res_test <- serial.test(model, lags.pt = 12, type = "PT.asymptotic")
#res_test
#plot(res_test, names="X1")
```
