---
title: "GLM Model"
output: html_notebook
---

```{r}
library(tscount)
library(urca)
```

```{r}
# Load dataset
df_atleast_50cts <- read.csv("/home/angps/Documents/Thesis/Data/data_>=50cts.csv")
full_df <- read.csv("/home/angps/Documents/Thesis/Data/df_>=1cts.csv")

# TRAIN TEST SPLIT:  Use 198 training data and 6 training data
train_small_df <- df_atleast_50cts[,1:198]
test_small_df <- df_atleast_50cts[,199:204]
train_full_df <- full_df[,1:198]
test_full_df <- full_df[,199:204]
```

```{r}
fit_and_evaluate_glm = function(train, test, past_obs, past_mean, link, distr){
    "
    Fit and evaluate using GLM model.
    Inputs: 
        train: Training dataset
        test: Testing dataset
        past_obs: Number of previous observations to be regressed on
        past_mean: Number of previous conditional mean to be regressed on
        link: Link function
        distr: conditional distribution
    "
    num_locs = dim(train)[1]
    errors <- 0
    error_arr <- c()
    fitted_val <- c()
    for (i in c(1 : num_locs)) {  # go through all locations
        # fit glm
        fit <- suppressWarnings(tsglm(as.numeric(train[i,]), model = list(past_obs = c(1 : past_obs), past_mean = past_mean),
                                      link = link, distr = distr)) 
        pred <- predict(fit, n.ahead=6, global=TRUE)  # predict 6 step ahead
        error_arr <- c(error_arr, residuals(fit, type='pearson'))
        fitted_val <- c(fitted_val, fit$fitted.values)
        error <- sum(((as.numeric(test[i,]) - pred$pred)) ^ 2)
        errors <- errors + error
    }
    return (list("Errors_array" = error_arr, "Fitted_Values" = fitted_val, "MSE" = errors/6))
}
```

```{r}
# Fit and evaluate on smaller subset of dataset
result = fit_and_evaluate_glm(train_small_df, test_small_df, past_obs = 6, past_mean = 18, link = 'identity', distr = 'poisson')
error_arr = result$Errors_array
MSE = result$MSE
fitted_val = result$Fitted_Values
print(paste0("MSE of fitting GLM on smaller subset of dataset: ", MSE))
```

```{r}
# Fit and evaluate on smaller subset of dataset
result = fit_and_evaluate_glm(train_full_df, test_full_df, past_obs = 1, past_mean = 1, link = 'identity', distr = 'poisson')
error_arr <- result$Errors_array
MSE <- result$MSE
fitted_val <- result$Fitted_Values
print(paste0("MSE of fitting GLM on full dataset: ", MSE))
```

```{r}
resids = error_arr
par(mfrow=c(2,2))
plot(resids, main="Residuals plot of GLM model", 
  xlab="Index", ylab="Residuals")
hist(resids, main = "Historgram of residuals")
qqnorm(resids)
qqline(resids)
dev.copy(jpeg,filename="/home/angps/Documents/Thesis/Report/Images/Full_GLM_resids.jpg");
dev.off ();
```

```{r}
plot(fitted_val$Fitted_Values, error_arr, main="Plot of residuals against fitted values", 
  xlab="Fitted values", ylab="Residuals")
dev.copy(jpeg,filename="/home/angps/Documents/Thesis/Report/Images/Full_GLM_resids_vs_fitted.jpg");
dev.off ();
```


